<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        caption {
            caption-side: top;
            text-align: left;
            padding-bottom: 5px;
            font-weight: bold;
        }
    </style>
    <title id="title">CTA4j Train Tracker</title>
</head>
<body>
<div id="div_trains">
</div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
<script>
    let station = null;

    function compareTrains(train0, train1) {
        if (!train0.hasOwnProperty("route") || !train0.hasOwnProperty("destination") ||
            !train0.hasOwnProperty("arrival_time")) {
            return 0;
        } //end if

        if (!train1.hasOwnProperty("route") || !train1.hasOwnProperty("destination") ||
            !train1.hasOwnProperty("arrival_time")) {
            return 0;
        } //end if

        let route0 = train0.route;

        let destination0 = train0.destination;

        let date0 = new Date(train0.arrival_time);

        let route1 = train1.route;

        let destination1 = train1.destination;

        let date1 = new Date(train1.arrival_time);

        if (route0 < route1) {
            return -1;
        } else if (route0 > route1) {
            return 1;
        } else if (destination0 < destination1) {
            return -1;
        } else if (destination0 > destination1) {
            return 1;
        } else if (date0 < date1) {
            return -1;
        } else if (date0 === date1) {
            return 0;
        } else {
            return 1;
        } //end if
    } //compareTrains

    function getTableHead() {
        let route = $("<th>").attr("scope", "col")
                             .text("Route");

        let destination = $("<th>").attr("scope", "col")
                                   .text("Destination");

        let run = $("<th>").attr("scope", "col")
                           .text("Run");

        let arrivalTime = $("<th>").attr("scope", "col")
                                   .text("Arrival Time");

        return $("<thead>").append(route, destination, run, arrivalTime);
    } //getTableHead

    function getTableRow(train) {
        let properties = ["route", "destination", "run", "arrival_time", "due", "delayed"];

        let error = false;

        properties.forEach(function (property) {
            if (!train.hasOwnProperty(property)) {
                error = true;
            } //end if
        });

        if (error) {
            return null;
        } //end if

        if (train.hasOwnProperty("station")) {
            station = train.station;
        } //end if

        let route = $("<td>").text(train.route)
                             .css("color", train.route);

        let destination = $("<td>").text(train.destination);

        let run = $("<td>").text(train.run);

        let date = new Date(train.arrival_time);

        let hour = date.getHours();

        let minute = date.getMinutes();

        let noon = 12;

        let ampm = (hour >= noon) ? "PM" : "AM";

        if (hour > noon) {
            hour -= 12;
        } //end if

        let padLength = 2;

        let padValue = "0";

        minute = String(minute).padStart(padLength, padValue);

        let dateString = `${hour}:${minute} ${ampm}`

        let arrivalTime = $("<td>").text(dateString);

        let tableRow = $("<tr>").append(route, destination, run, arrivalTime);

        if (train.due) {
            tableRow.addClass("table-success");
        } else if (train.delayed) {
            tableRow.addClass("table-danger");
        } //end if

        return tableRow;
    } //getTableRow

    function showTable(trains, div_trains) {
        let tableHead = getTableHead();

        let tableBody = $("<tbody>");

        trains.forEach(function (train) {
            let tableRow = getTableRow(train);

            if (!tableRow) {
                return;
            } //end if

            tableBody.append(tableRow);
        });

        let table = $("<table>").addClass("table table-dark");

        if (station) {
            let titleText = `CTA4j Train Tracker -- ${station}`;

            $("#title").text(titleText);

            let caption = $("<caption>").text(station);

            table.append(caption);
        } //end if

        table.append(tableHead, tableBody);

        div_trains.html(table);
    } //showTable

    function updateTrains() {
        let urlParameters = new URLSearchParams(window.location.search);

        let div_trains = $("#div_trains");

        if (!urlParameters.has("map_id")) {
            div_trains.text("Error: A map ID is required");

            return;
        } //end if

        let mapId = urlParameters.get("map_id");

        let data = {
            "map_id": mapId
        };

        if (urlParameters.has("route")) {
            data["route"] = urlParameters.getAll("route");
        } //end if

        $.ajax({
            "type": "GET",
            "url": "https://cta4j.com/get-trains",
            "data": data,
            "success": function (response) {
                let trains = JSON.parse(response);

                trains.sort(compareTrains);

                showTable(trains, div_trains);
            },
            "error": function () {
                div_trains.text("Error: The train data could not be retrieved");
            }
        });
    } //updateTrains

    $(function () {
        updateTrains();

        let timeout = 60000;

        setInterval(updateTrains, timeout);
    });
</script>
</html>