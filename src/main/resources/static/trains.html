<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trains</title>
    <style>
        th {
            text-align: left;
        }
    </style>
</head>
<body>
<div id="div_trains">
</div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    function getTableHead() {
        let route = $("<th>").text("Route");

        let destination = $("<th>").text("Destination");

        let run = $("<th>").text("Run");

        let arrivalTime = $("<th>").text("Arrival Time");

        let due = $("<th>").text("Due");

        let delayed = $("<th>").text("Delayed");

        return $("<thead>").append(route, destination, run, arrivalTime, due, delayed);
    } //getTableHead

    function getTableRow(train) {
        let properties = ["route", "destination", "run", "arrival_time", "due", "delayed"];

        let error = false;

        properties.forEach(function (property) {
            if (!train.hasOwnProperty(property)) {
                error = true;
            } //end if
        });

        if (error) {
            return null;
        } //end if

        let route = $("<td>").text(train.route);

        let destination = $("<td>").text(train.destination);

        let run = $("<td>").text(train.run);

        let date = new Date(train.arrival_time);

        let hour = date.getHours();

        let minute = date.getMinutes();

        let noon = 12;

        let ampm = (hour >= noon) ? "PM" : "AM";

        if (hour > noon) {
            hour -= 12;
        } //end if

        let padLength = 2;

        let padValue = "0";

        hour = String(hour).padStart(padLength, padValue);

        minute = String(minute).padStart(padLength, padValue);

        let dateString = `${hour}:${minute} ${ampm}`

        let arrivalTime = $("<td>").text(dateString);

        let checkMark = "&#10003;";

        let dueHtml = train.due ? checkMark : "";

        let due = $("<td>").html(dueHtml);

        let delayedHtml = train.delayed ? checkMark : "";

        let delayed = $("<td>").html(delayedHtml);

        return $("<tr>").append(route, destination, run, arrivalTime, due, delayed);
    } //getTableRow

    function showTable(trains, div_trains) {
        let tableHead = getTableHead();

        let tableBody = $("<tbody>");

        trains.forEach(function (train) {
            let tableRow = getTableRow(train);

            if (!tableRow) {
                return;
            } //end if

            tableBody.append(tableRow);
        });

        let table = $("<table>").append(tableHead, tableBody);

        div_trains.html(table);
    } //showTable

    $(function () {
        let urlParameters = new URLSearchParams(window.location.search);

        let div_trains = $("#div_trains");

        if (!urlParameters.has("map_id")) {
            div_trains.text("Error: A map ID is required");

            return;
        } //end if

        let mapId = urlParameters.get("map_id");

        let data = {
            "map_id": mapId
        };

        if (urlParameters.has("route")) {
            data["route"] = urlParameters.getAll("route");
        } //end if

        $.ajax({
            "type": "GET",
            "url": "https://cta4j.com/get-trains",
            "data": data,
            "success": function (response) {
                let trains = JSON.parse(response);

                trains.sort(function (train0, train1) {
                    if (!train0.hasOwnProperty("route")) {
                        return 0;
                    } //end if

                    if (!train1.hasOwnProperty("route")) {
                        return 0;
                    } //end if

                    let route0 = train0.route;

                    let route1 = train1.route;

                    if (route0 < route1) {
                        return -1;
                    } else if (route0 === route1) {
                        return 0;
                    } else {
                        return 1;
                    } //end if
                });

                showTable(trains, div_trains);
            },
            "error": function () {
                div_trains.text("Error: The train data could not be retrieved");
            }
        });
    });
</script>
</html>