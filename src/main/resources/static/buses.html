<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="Description" content="CTA Bus Tracker, CTA, Chicago Transit Authority, Bus, CTA4j, Public Transit">
    <meta name="google-site-verification" content="XL7HoVn0BZ4EzPEG9ww8B9w6WQRNw6YEAW2XjuvLQOM">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css"
          integrity="sha256-FdatTf20PQr/rWg+cAKfl6j4/IY3oohFAJ7gVC3M34E=" crossorigin="anonymous">
    <style>
        html, head, body, .input-group-text, .form-control, .form-control:focus, .btn {
            background-color: #212529;
        }

        .input-group-text, .form-control, .btn {
            border: 1px solid dimgray;
        }

        .btn:hover {
            border: 1px solid dimgray;
            background-color: dimgray;
        }

        .btn:active {
            border: 1px solid gray;
            background-color: gray;
        }

        .btn:disabled, .btn[disabled]{
            border: 1px solid gray;
            background-color: black;
        }

        .card {
            background-color: black;
        }

        .popover {
            background-color: dimgray;
            border: 0;
        }

        .card-header, .input-group-text, .form-control, .form-control:focus, .popover-body {
            color: white;
        }

        .card-header {
            border-bottom-width: 1px;
            border-bottom-color: gray;
        }

        .popover .popover-arrow::before, .popover .popover-arrow::after {
            display: none;
        }
    </style>
    <title id="title">CTA4j Bus Tracker</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ENS0NL67SC"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        } //gtag

        gtag("js", new Date());

        gtag("config", "G-ENS0NL67SC");
    </script>
</head>
<body>
<input type="hidden" id="hidden_input_stop_id">
<div class="container mt-3">
    <div class="card mb-3" style="max-width: 30rem;">
        <div class="card-body">
            <form id="form_stop_id" class="row row-cols-sm-auto g-2 align-items-center">
                <div class="col-9">
                    <div class="input-group">
                        <div class="input-group-text">Stop ID</div>
                        <input type="text" class="form-control shadow-none" id="input_stop_id"
                               aria-describedby="The input for specifying a stop ID">
                        <div class="invalid-tooltip">
                            Please enter a valid stop ID.
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <button type="button" id="button_search" class="btn btn-primary" style="width: 100%;" disabled>
                        Search
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div class="card">
        <div id="div_stop_name" class="card-header">
        </div>
        <div class="card-body">
            <div id="div_buses">
                <table id="table_buses" class="table table-sm table-dark mt-0 mb-0">
                    <thead>
                    <tr>
                        <th scope="col">
                            Route
                        </th>
                        <th scope="col">
                            Destination
                        </th>
                        <th scope="col">
                            ID
                        </th>
                        <th scope="col">
                            ETA
                        </th>
                    </tr>
                    </thead>
                    <tbody id="tbody_buses">
                    </tbody>
                </table>
            </div>
            <div id="div_buses_error" class="alert alert-danger mt-0 mb-0" role="alert" style="display: none;">
                Error: The bus data could not be retrieved.
            </div>
        </div>
    </div>
</div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"
        integrity="sha256-AFAYEOkzB6iIKnTYZOdUf9FFje6lOTYdwRJKwTN5mks=" crossorigin="anonymous"></script>
<script>
    function compareBuses(bus0, bus1) {
        if (!bus0.hasOwnProperty("route") || !bus0.hasOwnProperty("destination") ||
            !bus0.hasOwnProperty("arrival_time")) {
            return 0;
        } //end if

        if (!bus1.hasOwnProperty("route") || !bus1.hasOwnProperty("destination") ||
            !bus1.hasOwnProperty("arrival_time")) {
            return 0;
        } //end if

        let route0 = bus0.route;

        let destination0 = bus0.destination;

        let date0 = new Date(bus0.arrival_time);

        let route1 = bus1.route;

        let destination1 = bus1.destination;

        let date1 = new Date(bus1.arrival_time);

        if (route0 < route1) {
            return -1;
        } else if (route0 > route1) {
            return 1;
        } else if (destination0 < destination1) {
            return -1;
        } else if (destination0 > destination1) {
            return 1;
        } else if (date0 < date1) {
            return -1;
        } else if (date0 === date1) {
            return 0;
        } else {
            return 1;
        } //end if
    } //compareBuses

    function getTableRow(bus) {
        let properties = ["route", "destination", "stop", "id", "prediction_time", "arrival_time", "delayed"];

        let error = false;

        properties.forEach(function (property) {
            if (!bus.hasOwnProperty(property)) {
                error = true;
            } //end if
        });

        if (error) {
            return null;
        } //end if

        $("#div_stop_name").text(bus.stop);

        let route = $("<td>").text(bus.route);

        let destination = $("<td>").text(bus.destination);

        let id = $("<td>").text(bus.id);

        let arrivalDate = new Date(bus.arrival_time);

        let arrivalMillis = arrivalDate.getTime();

        let predictionDate = new Date(bus.prediction_time);

        let predictionMillis = predictionDate.getTime();

        let difference = arrivalMillis - predictionMillis;

        let minuteMillis = 60000;

        difference /= minuteMillis;

        difference = Math.floor(difference);

        let etaString;

        if (difference <= 1) {
            etaString = "Due";
        } else {
            etaString = `${difference} min`;
        } //end if

        let eta = $("<td>").text(etaString);

        let tableRow = $("<tr>").append(route, destination, id, eta);

        let rowClass;

        let popoverContent;

        if (bus.delayed) {
            rowClass = "table-danger";

            popoverContent = "This bus is delayed.";
        } else if (difference <= 1) {
            rowClass = "table-success";

            popoverContent = "This bus is due.";
        } else {
            return tableRow;
        } //end if

        tableRow.addClass(rowClass);

        tableRow.popover({
            "trigger": "hover",
            "placement": "auto",
            "content": popoverContent
        });

        return tableRow;
    } //getTableRow

    function showTable(buses, div_buses) {
        let tableBody = $("#tbody_buses");

        tableBody.empty();

        buses.forEach(function (bus) {
            let tableRow = getTableRow(bus);

            if (!tableRow) {
                return;
            } //end if

            tableBody.append(tableRow);
        });

        $("#div_buses_error").hide();

        div_buses.show();
    } //showTable

    function updateBuses() {
        $("#div_stop_name").text("");

        let stopId = $("#hidden_input_stop_id").val();

        if (!stopId) {
            return;
        } //end if

        let data = {
            "stop_id": stopId
        };

        let urlParameters = new URLSearchParams(window.location.search);

        if (urlParameters.has("route")) {
            data["route"] = urlParameters.getAll("route");
        } //end if

        $.ajax({
            "type": "GET",
            "url": "https://cta4j.com/get-buses",
            "data": data,
            "success": function (response) {
                let buses = JSON.parse(response);

                buses.sort(compareBuses);

                let div_buses = $("#div_buses");

                showTable(buses, div_buses);
            },
            "error": function () {
                $("#div_buses").hide();

                $("#div_buses_error").show();
            }
        });
    } //updateBuses

    $(function () {
        $("#form_stop_id").submit( function (e) {
            e.preventDefault();
        });

        $("#input_stop_id").on("input", function () {
            let stopId = $(this).val();

            stopId = stopId.trim();

            if (stopId === "") {
                $(".invalid-tooltip").hide();

                $("#button_search").prop("disabled", true);

                return;
            } //end if

            let regex = /^\d+$/;

            if (stopId.match(regex)) {
                $(".invalid-tooltip").hide();

                $("#button_search").prop("disabled", false);
            } else {
                $(".invalid-tooltip").show();

                $("#button_search").prop("disabled", true);
            } //end if
        });

        $("#button_search").click(function () {
            let stopId = $("#input_stop_id").val();

            $("#hidden_input_stop_id").val(stopId);

            updateBuses();
        });

        let urlParameters = new URLSearchParams(window.location.search);

        let stopId = null;

        if (urlParameters.has("stop_id")) {
            stopId = urlParameters.get("stop_id");

            $("#hidden_input_stop_id").val(stopId);
        } //end if

        updateBuses();

        let timeout = 60000;

        setInterval(updateBuses, timeout);
    });
</script>
</html>